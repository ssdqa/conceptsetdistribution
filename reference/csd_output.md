# Concept Set Distribution – Output Generation

Using the tabular output generated by `csd_process`, this function will
build a graph to visualize the results. Each function configuration will
output a bespoke ggplot. Theming can be adjusted by the user after the
graph has been output using `+ theme()`. Most graphs can also be made
interactive using `make_interactive_squba()`

## Usage

``` r
csd_output(
  process_output,
  concept_set = NULL,
  vocab_tbl = NULL,
  num_variables = 10,
  num_mappings = 10,
  filter_variable = NULL,
  filter_concept = NULL,
  text_wrapping_char = 80,
  output_value = "prop_concept",
  large_n = FALSE,
  large_n_sites = NULL
)
```

## Arguments

- process_output:

  *tabular input* \|\| **required**

  The tabular output produced by `csd_process`

- concept_set:

  *tabular input* \|\| **optional**

  The concept set originally used in the `csd_process` function.
  Recommended if no vocab_tbl is provided but the concept names are
  available in the concept set.

- vocab_tbl:

  *tabular input* \|\| **optional**

  A vocabulary table containing concept names for the provided codes
  (ex: the OMOP concept table)

- num_variables:

  *integer* \|\| defaults to `30`

  An integer indicating the top N of variables to include for the
  exploratory analyses. The function will choose the most commonly
  occurring N variables to include in the plot.

- num_mappings:

  *integer* \|\| defaults to `30`

  An integer indicating the top N of concepts to include for the
  exploratory analyses. The function will choose the most commonly
  occurring N concepts per variable to include in the plot.

- filter_variable:

  *string or vector* \|\| defaults to `NULL`

  The specific variable(s) to display in the output. This parameter is
  required for the following check types:

  - `Single Site, Anomaly Detection, Cross-Sectional`

  - `Multi Site, Anomaly Detection, Cross-Sectional`

  - `Single Site, Exploratory, Longitudinal`

  - `Single Site, Anomaly Detection, Longitudinal`

  - `Multi Site, Exploratory, Longitudinal`

- filter_concept:

  *numeric/string or vector* \|\| defaults to `NULL`

  The specific code(s) to display in the output. This parameter is
  required for the following check types:

  - `Single Site, Anomaly Detection, Longitudinal`

  - `Multi Site, Exploratory, Longitudinal`

  - `Multi Site, Anomaly Detection, Longitudinal`

- text_wrapping_char:

  *integer* \|\| defaults to `80`

  An integer indicating the length limit for text on an axis before
  wrapping is enforced. This is only used for the
  `Multi Site, Anomaly Detection, Cross-Sectional` check type

- output_value:

  *string* \|\| defaults to `prop_concept`

  The name of the numerical column in `process_output` that should be
  used in the output. This parameter is required for the following check
  types:

  - `Multi-Site, Anomaly Detection, Cross-Sectional`

  - `Single Site, Exploratory, Longitudinal`

  - `Multi-Site, Exploratory, Longitudinal`

- large_n:

  *boolean* \|\| defaults to `FALSE`

  For Multi-Site analyses, a boolean indicating whether the large N
  visualization, intended for a high volume of sites, should be used.
  This visualization will produce high level summaries across all sites,
  with an option to add specific site comparators via the
  `large_n_sites` parameter.

- large_n_sites:

  *vector* \|\| defaults to `NULL`

  When `large_n = TRUE`, a vector of site names that can add site-level
  information to the plot for comparison across the high level summary
  information.

## Value

This function will produce a graph to visualize the results from
`csd_process` based on the parameters provided. The default output is
typically a static ggplot or gt object, but interactive elements can be
activated by passing the plot through `make_interactive_squba`. For a
more detailed description of output specific to each check type, see the
PEDSpace metadata repository

## Examples

``` r
#' Source setup file
source(system.file('setup.R', package = 'conceptsetdistribution'))

getwd()
#> [1] "/home/runner/work/conceptsetdistribution/conceptsetdistribution/docs/reference"

#' Create in-memory RSQLite database using data in extdata directory
conn <- mk_testdb_omop()

#' Establish connection to database and generate internal configurations
initialize_dq_session(session_name = 'csd_process_test',
                      working_directory = my_directory,
                      db_conn = conn,
                      is_json = FALSE,
                      file_subdirectory = my_file_folder,
                      cdm_schema = NA)
#> Connected to: :memory:@NA
#> To see environment settings, run `get_argos_default()`

#' Build mock study cohort
cohort <- cdm_tbl('person') %>% dplyr::distinct(person_id) %>%
  dplyr::mutate(start_date = as.Date(-5000),
                #RSQLite does not store date objects,
                #hence the numerics
                end_date = as.Date(15000),
                site = ifelse(person_id %in% c(1:6), 'synth1', 'synth2'))

#' Prepare input tables
csd_domain_tbl <- dplyr::tibble(domain = 'condition_occurrence',
                                concept_field = 'condition_concept_id',
                                date_field = 'condition_start_date',
                                vocabulary_field = NA)

csd_concept_tbl <- read_codeset('dx_hypertension') %>%
  dplyr::mutate(domain = 'condition_occurrence',
                variable = 'hypertension')

#' Execute `csd_process` function
#' This example will use the single site, exploratory, cross sectional
#' configuration
csd_process_example <- csd_process(cohort = cohort,
                                   multi_or_single_site = 'single',
                                   anomaly_or_exploratory = 'exploratory',
                                   time = FALSE,
                                   omop_or_pcornet = 'omop',
                                   domain_tbl = csd_domain_tbl,
                                   concept_set = csd_concept_tbl) %>%
  suppressMessages()
#> ┌ Output Function Details ──────────────────────────────────────┐
#> │ You can optionally use this dataframe in the accompanying     │
#> │ `csd_output` function. Here are the parameters you will need: │
#> │                                                               │
#> │ Always Required: process_output                               │
#> │ Required for Check: num_variables, num_mappings               │
#> │ Optional: concept_set, vocab_tbl                              │
#> │                                                               │
#> │ See ?csd_output for more details.                             │
#> └───────────────────────────────────────────────────────────────┘

csd_process_example
#> # A tibble: 1 × 7
#>   variable     ct_denom concept_id ct_concept prop_concept site  output_function
#>   <chr>           <int> <chr>           <int>        <dbl> <chr> <chr>          
#> 1 hypertension        5 320128              5            1 comb… csd_ss_exp_cs  

#' Execute `csd_output` function
csd_output_example <- csd_output(process_output = csd_process_example,
                                 concept_set = csd_concept_tbl,
                                 vocab_tbl = NULL) %>%
  suppressMessages()

csd_output_example[[1]]

csd_output_example[[2]]


  
    Concept Reference Table
    
  
  
  {"x":{"tag":{"name":"Reactable","attribs":{"data":{"site":["combined"],"variable":["hypertension"],"denom_col":[5]},"columns":[{"id":"site","name":"site","type":"character","na":"NA","minWidth":125,"style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\nif (colInfo.id === 'site' & rowIndex === 1) {\n  return { backgroundColor: '#FF4D6F', color: '#FFFFFF' }\n}\n\n}","html":true,"align":"left"},{"id":"variable","name":"variable","type":"character","na":"NA","minWidth":125,"style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\nif (colInfo.id === 'site' & rowIndex === 1) {\n  return { backgroundColor: '#FF4D6F', color: '#FFFFFF' }\n}\n\n}","html":true,"align":"left"},{"id":"denom_col","name":"Total Count","type":"numeric","na":"NA","minWidth":125,"style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\nif (colInfo.id === 'site' & rowIndex === 1) {\n  return { backgroundColor: '#FF4D6F', color: '#FFFFFF' }\n}\n\n}","cell":["5"],"html":true,"align":"right"}],"searchable":true,"defaultPageSize":10,"showPageSizeOptions":false,"pageSizeOptions":[10,25,50,100],"paginationType":"numbers","showPagination":true,"showPageInfo":true,"minRows":1,"height":"auto","theme":{"color":"#333333","backgroundColor":"#FFFFFF","stripedColor":"rgba(128,128,128,0.05)","style":{"font-family":"system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif","fontSize":"16px"},"tableStyle":{"borderTopStyle":"solid","borderTopWidth":"2px","borderTopColor":"#D3D3D3"},"headerStyle":{"fontWeight":"normal","backgroundColor":"transparent","borderBottomStyle":"solid","borderBottomWidth":"2px","borderBottomColor":"#D3D3D3"},"groupHeaderStyle":{"fontWeight":"normal","backgroundColor":"transparent","borderBottomStyle":"solid","borderBottomWidth":"2px","borderBottomColor":"#D3D3D3"},"cellStyle":{"fontWeight":"normal"}},"elementId":"rewkadgwxb","dataKey":"2e9ecd14f91854aca304e1b0fda02dbc"},"children":[]},"class":"reactR_markup"},"evals":["tag.attribs.columns.0.style","tag.attribs.columns.1.style","tag.attribs.columns.2.style"],"jsHooks":[]}


#' Easily convert the graph into an interactive ggiraph or plotly object with
#' `make_interactive_squba()`

make_interactive_squba(csd_output_example[[1]])

{"x":{"html":"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' class='ggiraph-svg' role='graphics-document' id='svg_c7483268bafca56c' viewBox='0 0 432 360'>\n <defs id='svg_c7483268bafca56c_defs'>\n  <clipPath id='svg_c7483268bafca56c_c1'>\n   <rect x='0' y='0' width='432' height='360'/>\n  <\/clipPath>\n  <clipPath id='svg_c7483268bafca56c_c2'>\n   <rect x='57.03' y='49.84' width='290.82' height='268.95'/>\n  <\/clipPath>\n  <clipPath id='svg_c7483268bafca56c_c3'>\n   <rect x='57.03' y='23.32' width='290.82' height='26.52'/>\n  <\/clipPath>\n <\/defs>\n <g id='svg_c7483268bafca56c_rootg' class='ggiraph-svg-rootg'>\n  <g clip-path='url(#svg_c7483268bafca56c_c1)'>\n   <rect x='0' y='0' width='432' height='360' fill='#FFFFFF' fill-opacity='1' stroke='#FFFFFF' stroke-opacity='1' stroke-width='0.75' stroke-linejoin='round' stroke-linecap='round' class='ggiraph-svg-bg'/>\n   <rect x='0' y='0' width='432' height='360' fill='#FFFFFF' fill-opacity='1' stroke='none'/>\n  <\/g>\n  <g clip-path='url(#svg_c7483268bafca56c_c2)'>\n   <polyline points='57.03,184.31 347.85,184.31' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='1.07' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='202.44,318.79 202.44,49.84' fill='none' stroke='#EBEBEB' stroke-opacity='1' stroke-width='1.07' stroke-linejoin='round' stroke-linecap='butt'/>\n   <rect id='svg_c7483268bafca56c_e1' x='81.26' y='72.25' width='242.35' height='224.13' fill='#FBB761' fill-opacity='1' stroke='none' title='Essential hypertension'/>\n   <text x='199.72' y='187.42' font-size='6.4pt' font-family='DejaVu Sans'>1<\/text>\n  <\/g>\n  <g clip-path='url(#svg_c7483268bafca56c_c3)'>\n   <text x='173.52' y='35.03' font-size='6.6pt' font-family='DejaVu Sans' fill='#1A1A1A' fill-opacity='1'>hypertension<\/text>\n   <text x='162.52' y='44.54' font-size='6.6pt' font-family='DejaVu Sans' fill='#1A1A1A' fill-opacity='1'> Total Mappings: 1<\/text>\n  <\/g>\n  <g clip-path='url(#svg_c7483268bafca56c_c1)'>\n   <text x='173.52' y='330.14' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>hypertension<\/text>\n   <text x='162.52' y='339.64' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'> Total Mappings: 1<\/text>\n   <text x='18.53' y='187.52' font-size='6.6pt' font-family='DejaVu Sans' fill='#4D4D4D' fill-opacity='1'>320128<\/text>\n   <text transform='translate(13.50,214.02) rotate(-90.00)' font-size='8.25pt' font-family='DejaVu Sans'>concept_id<\/text>\n   <text x='364.28' y='142.38' font-size='8.25pt' font-family='DejaVu Sans'>Proportion<\/text>\n   <image x='364.28' y='149.01' width='17.28' height='86.4' preserveAspectRatio='none' xlink:href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAEsCAYAAAACUNnVAAAAHUlEQVQ4jWP4vT3xPxMDAwPDKDFKjBKjxCgxXAgA1SgFadr2HN0AAAAASUVORK5CYII=' xmlns:xlink='http://www.w3.org/1999/xlink'/>\n   <polyline points='378.11,192.21 381.56,192.21' fill='none' stroke='#FFFFFF' stroke-opacity='1' stroke-width='0.37' stroke-linejoin='round' stroke-linecap='butt'/>\n   <polyline points='367.74,192.21 364.28,192.21' fill='none' stroke='#FFFFFF' stroke-opacity='1' stroke-width='0.37' stroke-linejoin='round' stroke-linecap='butt'/>\n   <text x='387.04' y='195.42' font-size='6.6pt' font-family='DejaVu Sans'>1<\/text>\n   <text x='57.03' y='15.1' font-size='9.9pt' font-family='DejaVu Sans'>Top 10 Concepts For Top 10 Variables<\/text>\n  <\/g>\n <\/g>\n<\/svg>","js":null,"uid":"svg_c7483268bafca56c","ratio":1.2,"settings":{"tooltip":{"css":".tooltip_SVGID_ { padding:5px;background:black;color:white;border-radius:2px;text-align:left; ; position:absolute;pointer-events:none;z-index:999;}","placement":"doc","opacity":0.9,"offx":10,"offy":10,"use_cursor_pos":true,"use_fill":false,"use_stroke":false,"delay_over":200,"delay_out":500},"hover":{"css":".hover_data_SVGID_ { fill:orange;stroke:black;cursor:pointer; }\ntext.hover_data_SVGID_ { stroke:none;fill:orange; }\ncircle.hover_data_SVGID_ { fill:orange;stroke:black; }\nline.hover_data_SVGID_, polyline.hover_data_SVGID_ { fill:none;stroke:orange; }\nrect.hover_data_SVGID_, polygon.hover_data_SVGID_, path.hover_data_SVGID_ { fill:orange;stroke:none; }\nimage.hover_data_SVGID_ { stroke:orange; }","reactive":true,"nearest_distance":null},"hover_inv":{"css":""},"hover_key":{"css":".hover_key_SVGID_ { fill:orange;stroke:black;cursor:pointer; }\ntext.hover_key_SVGID_ { stroke:none;fill:orange; }\ncircle.hover_key_SVGID_ { fill:orange;stroke:black; }\nline.hover_key_SVGID_, polyline.hover_key_SVGID_ { fill:none;stroke:orange; }\nrect.hover_key_SVGID_, polygon.hover_key_SVGID_, path.hover_key_SVGID_ { fill:orange;stroke:none; }\nimage.hover_key_SVGID_ { stroke:orange; }","reactive":true},"hover_theme":{"css":".hover_theme_SVGID_ { fill:orange;stroke:black;cursor:pointer; }\ntext.hover_theme_SVGID_ { stroke:none;fill:orange; }\ncircle.hover_theme_SVGID_ { fill:orange;stroke:black; }\nline.hover_theme_SVGID_, polyline.hover_theme_SVGID_ { fill:none;stroke:orange; }\nrect.hover_theme_SVGID_, polygon.hover_theme_SVGID_, path.hover_theme_SVGID_ { fill:orange;stroke:none; }\nimage.hover_theme_SVGID_ { stroke:orange; }","reactive":true},"select":{"css":".select_data_SVGID_ { fill:red;stroke:black;cursor:pointer; }\ntext.select_data_SVGID_ { stroke:none;fill:red; }\ncircle.select_data_SVGID_ { fill:red;stroke:black; }\nline.select_data_SVGID_, polyline.select_data_SVGID_ { fill:none;stroke:red; }\nrect.select_data_SVGID_, polygon.select_data_SVGID_, path.select_data_SVGID_ { fill:red;stroke:none; }\nimage.select_data_SVGID_ { stroke:red; }","type":"multiple","only_shiny":true,"selected":[]},"select_inv":{"css":""},"select_key":{"css":".select_key_SVGID_ { fill:red;stroke:black;cursor:pointer; }\ntext.select_key_SVGID_ { stroke:none;fill:red; }\ncircle.select_key_SVGID_ { fill:red;stroke:black; }\nline.select_key_SVGID_, polyline.select_key_SVGID_ { fill:none;stroke:red; }\nrect.select_key_SVGID_, polygon.select_key_SVGID_, path.select_key_SVGID_ { fill:red;stroke:none; }\nimage.select_key_SVGID_ { stroke:red; }","type":"single","only_shiny":true,"selected":[]},"select_theme":{"css":".select_theme_SVGID_ { fill:red;stroke:black;cursor:pointer; }\ntext.select_theme_SVGID_ { stroke:none;fill:red; }\ncircle.select_theme_SVGID_ { fill:red;stroke:black; }\nline.select_theme_SVGID_, polyline.select_theme_SVGID_ { fill:none;stroke:red; }\nrect.select_theme_SVGID_, polygon.select_theme_SVGID_, path.select_theme_SVGID_ { fill:red;stroke:none; }\nimage.select_theme_SVGID_ { stroke:red; }","type":"single","only_shiny":true,"selected":[]},"zoom":{"min":1,"max":1,"duration":300,"default_on":false},"toolbar":{"position":"topright","pngname":"diagram","tooltips":null,"fixed":false,"hidden":[],"delay_over":200,"delay_out":500},"sizing":{"rescale":true,"width":1}}},"evals":[],"jsHooks":[]}
```
